<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simple Iframe Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                padding: 20px;
                background: #f0f0f0;
            }
            .container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            iframe {
                width: 100%;
                height: 400px;
                border: 2px solid #007acc;
                border-radius: 8px;
            }
            .log {
                background: #f8f8f8;
                border: 1px solid #ddd;
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-family: monospace;
                font-size: 12px;
                max-height: 300px;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>🧪 Simple Iframe Communication Test</h1>
            <p>
                This test manually creates an AdvantageWrapper and tests iframe
                communication without pre-wrapping complexity.
            </p>

            <div id="log" class="log">Test Log:<br /></div>

            <div id="wrapper-container">
                <!-- Wrapper will be created here -->
            </div>
        </div>

        <script type="module">
            import { Advantage } from "../../src/advantage/index";

            function log(message, type = "info") {
                const timestamp = new Date().toLocaleTimeString();
                const logEl = document.getElementById("log");
                const color =
                    type === "success"
                        ? "green"
                        : type === "error"
                        ? "red"
                        : type === "warning"
                        ? "orange"
                        : "black";

                if (logEl) {
                    logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
                    logEl.scrollTop = logEl.scrollHeight;
                }
                console.log(`[${timestamp}] ${message}`);
            }

            async function runTest() {
                try {
                    log("🚀 Starting simple iframe test...");

                    // 1. Configure Advantage
                    log(
                        "📝 Configuring Advantage with TOPSCROLL integration..."
                    );
                    const advantage = Advantage.getInstance();
                    advantage.configure({
                        formatIntegrations: [
                            {
                                format: "TOPSCROLL",
                                setup: (wrapper, iframe) => {
                                    log("🔧 TOPSCROLL setup called", "success");
                                    return Promise.resolve();
                                },
                                close: () => {
                                    log("🔄 TOPSCROLL close called");
                                },
                                reset: () => {
                                    log("🔄 TOPSCROLL reset called");
                                }
                            }
                        ]
                    });

                    // 2. Create AdvantageWrapper manually
                    log("🏗️ Creating AdvantageWrapper manually...");
                    const wrapper = document.createElement("advantage-wrapper");

                    // Create the slot structure
                    const adSlot = document.createElement("div");
                    adSlot.setAttribute("slot", "advantage-ad-slot");
                    wrapper.appendChild(adSlot);

                    // Add wrapper to DOM
                    const container =
                        document.getElementById("wrapper-container");
                    container.appendChild(wrapper);

                    log(
                        "✅ AdvantageWrapper created and added to DOM",
                        "success"
                    );

                    // 3. Wait a moment for wrapper to initialize
                    await new Promise((resolve) => setTimeout(resolve, 500));

                    // Check wrapper state
                    log(
                        `🔍 Wrapper messageHandler: ${
                            wrapper.messageHandler ? "AVAILABLE" : "MISSING"
                        }`,
                        wrapper.messageHandler ? "success" : "error"
                    );
                    log(
                        `🔍 Wrapper contentNodes: ${wrapper.contentNodes.length}`,
                        "info"
                    );

                    // 4. Create and add iframe
                    log("📱 Creating iframe...");
                    const iframe = document.createElement("iframe");
                    iframe.src = "./creative-iframe.html";
                    iframe.style.width = "100%";
                    iframe.style.height = "400px";
                    iframe.style.border = "1px solid #ccc";
                    iframe.style.borderRadius = "8px";

                    adSlot.appendChild(iframe);
                    log("✅ Iframe added to wrapper", "success");

                    // 5. Wait and check if iframe is detected
                    await new Promise((resolve) => setTimeout(resolve, 1000));
                    log(
                        `🔍 ContentNodes after iframe: ${wrapper.contentNodes.length}`,
                        "info"
                    );

                    // Check if the iframe is in contentNodes
                    const foundIframes = wrapper.contentNodes.flatMap(
                        (node) => {
                            const collectIframes = (node) => {
                                let iframes = [];
                                if (node.nodeType === Node.ELEMENT_NODE) {
                                    const element = node;
                                    if (element.tagName === "IFRAME") {
                                        iframes.push(element);
                                    }
                                    element.childNodes.forEach((child) => {
                                        iframes = iframes.concat(
                                            collectIframes(child)
                                        );
                                    });
                                }
                                return iframes;
                            };
                            return collectIframes(node);
                        }
                    );

                    log(
                        `🔍 Detected iframes: ${foundIframes.length}`,
                        foundIframes.length > 0 ? "success" : "error"
                    );

                    if (foundIframes.length > 0) {
                        const testIframe = foundIframes[0];
                        log(
                            `🔍 First iframe contentWindow: ${
                                testIframe.contentWindow
                                    ? "AVAILABLE"
                                    : "NOT AVAILABLE"
                            }`,
                            testIframe.contentWindow ? "success" : "error"
                        );
                    }

                    // 6. Monitor for messages
                    let messageCount = 0;
                    window.addEventListener("message", (event) => {
                        if (event.data && event.data.type === "ADVANTAGE") {
                            messageCount++;
                            log(
                                `📨 ADVANTAGE message #${messageCount}: ${event.data.action}`,
                                "info"
                            );
                            log(
                                `   - SessionID: ${event.data.sessionID}`,
                                "info"
                            );
                            log(
                                `   - Source matches iframe: ${
                                    event.source === iframe.contentWindow
                                }`,
                                "info"
                            );

                            // Check if wrapper can find this source
                            const currentIframes = wrapper.contentNodes.flatMap(
                                (node) => {
                                    const collectIframes = (node) => {
                                        let iframes = [];
                                        if (
                                            node.nodeType === Node.ELEMENT_NODE
                                        ) {
                                            const element = node;
                                            if (element.tagName === "IFRAME") {
                                                iframes.push(element);
                                            }
                                            element.childNodes.forEach(
                                                (child) => {
                                                    iframes = iframes.concat(
                                                        collectIframes(child)
                                                    );
                                                }
                                            );
                                        }
                                        return iframes;
                                    };
                                    return collectIframes(node);
                                }
                            );

                            const matchingIframes = currentIframes.filter(
                                (f) => f.contentWindow === event.source
                            );
                            log(
                                `   - Wrapper can find source: ${
                                    matchingIframes.length > 0
                                }`,
                                matchingIframes.length > 0 ? "success" : "error"
                            );
                        }
                    });

                    log(
                        "✅ Test setup complete. Waiting for iframe to load and communicate...",
                        "success"
                    );
                } catch (error) {
                    log(`❌ Test error: ${error.message}`, "error");
                    console.error("Full error:", error);
                }
            }

            // Start test when page loads
            document.addEventListener("DOMContentLoaded", runTest);
        </script>
    </body>
</html>
