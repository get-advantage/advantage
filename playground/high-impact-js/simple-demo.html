<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simple Pre-wrapping Demo</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            advantage-wrapper {
                border: 3px solid #10b981;
                border-radius: 8px;
                display: block;
                margin: 10px 0;
                padding: 5px;
            }

            .ad-unit {
                border: 2px dashed #6b7280;
                padding: 20px;
                background: #f9fafb;
                text-align: center;
                border-radius: 4px;
            }

            .before-after {
                display: flex;
                gap: 20px;
                margin: 20px 0;
            }

            .demo-step {
                flex: 1;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 20px;
            }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Pre-initialize highImpactJs -->
        <script>
            window.highImpactJs = window.highImpactJs || { cmd: [] };
        </script>

        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold mb-8">Simple Pre-wrapping Demo</h1>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
                <p class="text-blue-800">
                    This demo shows how calling
                    <code class="bg-blue-100 px-1 rounded">defineSlot()</code>
                    immediately wraps the ad unit with an AdvantageWrapper,
                    enabling instant communication with Advantage creatives.
                </p>
            </div>

            <div class="before-after">
                <div class="demo-step">
                    <h3 class="text-lg font-semibold mb-4">
                        üìã Step 1: Before defineSlot()
                    </h3>
                    <div id="simple-ad-unit" class="ad-unit">
                        <div class="font-semibold">Simple Ad Unit</div>
                        <div class="text-sm text-gray-500">
                            ID: simple-ad-unit
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            Not wrapped yet
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        Standard HTML div element - no AdvantageWrapper present.
                    </p>
                </div>

                <div class="demo-step">
                    <h3 class="text-lg font-semibold mb-4">
                        üéØ Step 2: After defineSlot()
                    </h3>
                    <div id="wrapped-result" class="text-gray-500">
                        Click the button to see the result ‚Üí
                    </div>
                </div>
            </div>

            <div class="text-center my-8">
                <button
                    id="demo-button"
                    class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed"
                    disabled
                >
                    ‚è≥ Loading...
                </button>
            </div>

            <div
                class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm"
            >
                <div class="font-semibold mb-2">Console Output:</div>
                <div id="console-output">[INFO] Page loading...<br /></div>
            </div>
        </div>

        <!-- Load Advantage and run demo -->
        <script type="module">
            import { Advantage } from "../../src/advantage";

            let isReady = false;

            function log(message, type = "info") {
                const timestamp = new Date().toLocaleTimeString();
                const output = document.getElementById("console-output");
                const color =
                    {
                        info: "#3b82f6",
                        success: "#10b981",
                        error: "#ef4444",
                        warning: "#f59e0b"
                    }[type] || "#6b7280";

                output.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
                output.scrollTop = output.scrollHeight;
            }

            function updateButton(text, enabled = true) {
                const button = document.getElementById("demo-button");
                button.textContent = text;
                button.disabled = !enabled;
            }

            function showWrappedResult() {
                const adUnit = document.getElementById("simple-ad-unit");
                const wrapper = adUnit.closest("advantage-wrapper");

                if (wrapper) {
                    const allowedFormats =
                        wrapper.getAttribute("allowed-formats");
                    document.getElementById("wrapped-result").innerHTML = `
                    <div class="text-green-600 font-semibold">‚úÖ Successfully Wrapped!</div>
                    <div class="text-sm text-gray-600 mt-2">
                        The ad unit is now inside an &lt;advantage-wrapper&gt;
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        Allowed formats: ${allowedFormats}
                    </div>
                    <div class="mt-3 p-2 bg-green-50 border border-green-200 rounded text-xs text-green-700">
                        üéâ Advantage creatives can now communicate immediately!
                    </div>
                `;
                } else {
                    document.getElementById("wrapped-result").innerHTML = `
                    <div class="text-red-600 font-semibold">‚ùå Wrapping Failed</div>
                    <div class="text-sm text-gray-600 mt-2">
                        The ad unit was not wrapped as expected.
                    </div>
                `;
                }
            }

            function runDemo() {
                if (!isReady) {
                    log("‚ùå Demo not ready yet", "error");
                    return;
                }

                log("üé¨ Running demo...");

                try {
                    // Check if ad unit is initially wrapped (should not be)
                    const initialWrapper = document
                        .getElementById("simple-ad-unit")
                        .closest("advantage-wrapper");
                    if (initialWrapper) {
                        log("‚ö†Ô∏è Ad unit was already wrapped", "warning");
                    } else {
                        log("‚úÖ Ad unit not wrapped initially (correct)");
                    }

                    // Call defineSlot to trigger pre-wrapping
                    log("üìù Calling window.highImpactJs.defineSlot()...");
                    window.highImpactJs.defineSlot({
                        template: "topscroll",
                        adUnitId: "simple-ad-unit",
                        sizes: [
                            [728, 90],
                            [970, 250]
                        ]
                    });

                    // Check result after short delay
                    setTimeout(() => {
                        const afterWrapper = document
                            .getElementById("simple-ad-unit")
                            .closest("advantage-wrapper");
                        if (afterWrapper) {
                            const allowedFormats =
                                afterWrapper.getAttribute("allowed-formats");
                            log(
                                `üéâ Success! Ad unit pre-wrapped with formats: ${allowedFormats}`,
                                "success"
                            );
                            showWrappedResult();
                            updateButton("‚úÖ Demo Complete - Try Again?");
                        } else {
                            log("‚ùå Pre-wrapping failed", "error");
                            showWrappedResult();
                            updateButton("‚ùå Demo Failed - Try Again?");
                        }
                    }, 500);
                } catch (error) {
                    log(`‚ùå Error: ${error.message}`, "error");
                    updateButton("‚ùå Error - Try Again?");
                }
            }

            // Initialize
            log("üöÄ Initializing Advantage...");
            const advantage = Advantage.getInstance();

            advantage.configure({
                enableHighImpactCompatibility: true,
                formatIntegrations: [
                    {
                        format: "TOPSCROLL",
                        setup: () => {
                            log(
                                "üé¨ TopScroll format setup would be called here"
                            );
                            return Promise.resolve();
                        }
                    }
                ]
            });

            // Wait for initialization
            let attempts = 0;
            const checkReady = () => {
                attempts++;
                if (window.highImpactJs && window.highImpactJs.defineSlot) {
                    isReady = true;
                    log("‚úÖ High Impact JS compatibility ready!", "success");
                    updateButton("üöÄ Run Pre-wrapping Demo");
                    document
                        .getElementById("demo-button")
                        .addEventListener("click", runDemo);
                } else if (attempts < 20) {
                    setTimeout(checkReady, 250);
                } else {
                    log("‚ùå Timeout waiting for compatibility layer", "error");
                    updateButton("‚ùå Initialization Failed");
                }
            };

            setTimeout(checkReady, 500);
        </script>
    </body>
</html>
