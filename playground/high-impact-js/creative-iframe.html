<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Advantage Creative (Iframe)</title>
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family: Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-align: center;
                opacity: 0;
                transition: opacity 0.5s ease;
            }

            .creative-content {
                max-width: 600px;
                margin: 0 auto;
            }

            .status {
                padding: 10px;
                margin: 10px;
                border-radius: 4px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                font-size: 14px;
            }

            .success {
                background: rgba(34, 197, 94, 0.2);
                border: 1px solid rgba(34, 197, 94, 0.5);
            }

            .error {
                background: rgba(239, 68, 68, 0.2);
                border: 1px solid rgba(239, 68, 68, 0.5);
            }

            .cta-button {
                background: #ff6b6b;
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 25px;
                font-size: 18px;
                cursor: pointer;
                margin: 20px;
                transition: transform 0.2s;
            }

            .cta-button:hover {
                transform: scale(1.05);
            }
        </style>
    </head>
    <body>
        <div class="creative-content">
            <h1>üöÄ Advantage Creative (Iframe)</h1>
            <p>
                Testing immediate communication with AdvantageWrapper from
                iframe context
            </p>

            <div id="communication-status" class="status">
                üì° Initializing...
            </div>

            <button class="cta-button" onclick="requestFormat()">
                Request TopScroll Format
            </button>

            <div id="format-status" class="status">
                ‚è≥ Ready to request format
            </div>

            <div
                id="debug-log"
                style="
                    background: rgba(0, 0, 0, 0.3);
                    border-radius: 8px;
                    padding: 15px;
                    margin: 20px 0;
                    text-align: left;
                    font-family: monospace;
                    font-size: 12px;
                    max-height: 200px;
                    overflow-y: auto;
                "
            >
                <div>Creative Debug Log:</div>
            </div>
        </div>

        <script type="module">
            import {
                AdvantageCreativeMessenger,
                AdvantageMessageAction,
                AdvantageFormatName
            } from "../../src/advantage/messaging/creative-side";

            let messenger = null;
            let sessionActive = false;
            let initializationInProgress = false;

            // Send messages to parent window for logging
            function sendToParent(type, data) {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type, ...data }, "*");
                }
            }

            function log(message, type = "info") {
                const timestamp = new Date().toLocaleTimeString();
                const logEl = document.getElementById("debug-log");
                const color =
                    type === "success"
                        ? "#22c55e"
                        : type === "error"
                        ? "#ef4444"
                        : type === "warning"
                        ? "#f59e0b"
                        : "#3b82f6";

                if (logEl) {
                    logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
                    logEl.scrollTop = logEl.scrollHeight;
                }

                // Also send to parent
                sendToParent("creative-log", { message, logType: type });
            }

            function updateStatus(elementId, message, type = "default") {
                const el = document.getElementById(elementId);
                if (el) {
                    el.textContent = message;
                    el.className = `status ${type}`;
                }

                // Also send to parent
                sendToParent("creative-status", { message, statusType: type });
            }

            async function initializeCommunication() {
                // Prevent double initialization
                if (initializationInProgress || sessionActive) {
                    log(
                        "‚ö†Ô∏è Initialization already in progress or completed, skipping...",
                        "warning"
                    );
                    return;
                }

                initializationInProgress = true;

                try {
                    updateStatus(
                        "communication-status",
                        "üì° [IFRAME] Initializing creative communication...",
                        "default"
                    );

                    log("üé¨ Starting creative initialization from iframe...");
                    log(
                        `üìç Current window: ${
                            window === window.top ? "top" : "iframe"
                        }`
                    );
                    log(
                        `üìç Parent window: ${
                            window.parent !== window
                                ? "AVAILABLE"
                                : "NOT AVAILABLE"
                        }`
                    );

                    // Debug: Check for AdvantageWrapper in parent
                    if (window.parent && window.parent !== window) {
                        try {
                            const parentWrapper =
                                window.parent.document.querySelector(
                                    "advantage-wrapper"
                                );
                            log(
                                `üîç Parent AdvantageWrapper: ${
                                    parentWrapper ? "FOUND" : "NOT FOUND"
                                }`
                            );
                        } catch (e) {
                            log(
                                `üîç Cannot access parent DOM (cross-origin): ${e.message}`,
                                "warning"
                            );
                        }
                    }

                    // Give parent time to detect the iframe before starting session
                    log("‚è≥ Waiting for parent iframe detection...", "info");

                    // Keep checking until parent can find us
                    let detectionAttempts = 0;
                    const maxDetectionAttempts = 20;

                    while (detectionAttempts < maxDetectionAttempts) {
                        // Check if parent window can access our iframe
                        try {
                            if (window.parent && window.parent !== window) {
                                // Send a test message to see if parent detects us
                                const testResult = await new Promise(
                                    (resolve) => {
                                        const timeoutId = setTimeout(
                                            () => resolve(false),
                                            100
                                        );

                                        const testHandler = (event) => {
                                            if (
                                                event.data &&
                                                event.data.type ===
                                                    "IFRAME_DETECTION_TEST_RESPONSE"
                                            ) {
                                                clearTimeout(timeoutId);
                                                window.removeEventListener(
                                                    "message",
                                                    testHandler
                                                );
                                                resolve(true);
                                            }
                                        };

                                        window.addEventListener(
                                            "message",
                                            testHandler
                                        );
                                        window.parent.postMessage(
                                            {
                                                type: "IFRAME_DETECTION_TEST",
                                                source: "creative-iframe"
                                            },
                                            "*"
                                        );
                                    }
                                );

                                if (testResult) {
                                    log(
                                        "‚úÖ Parent can detect iframe, proceeding with session...",
                                        "success"
                                    );
                                    break;
                                }
                            }
                        } catch (e) {
                            log(
                                `‚ö†Ô∏è Detection attempt ${
                                    detectionAttempts + 1
                                } failed: ${e.message}`,
                                "warning"
                            );
                        }

                        detectionAttempts++;
                        await new Promise((resolve) =>
                            setTimeout(resolve, 100)
                        );
                    }

                    if (detectionAttempts >= maxDetectionAttempts) {
                        log(
                            "‚ö†Ô∏è Maximum detection attempts reached, proceeding anyway...",
                            "warning"
                        );
                    }

                    log("üöÄ Creating AdvantageCreativeMessenger...");
                    messenger = new AdvantageCreativeMessenger();

                    log("üì° Starting session with parent AdvantageWrapper...");
                    log(
                        `üîç Session details: window.top = ${
                            window.top ? "available" : "null"
                        }`
                    );
                    log(
                        `üîç Parent window = ${
                            window.parent ? "available" : "null"
                        }`
                    );
                    log(`üîç Window hierarchy: iframe -> parent -> top`);

                    // Add timeout logging
                    const sessionPromise = messenger.startSession();
                    let timeoutReached = false;

                    // Log timeout warning
                    setTimeout(() => {
                        if (!sessionActive && !timeoutReached) {
                            timeoutReached = true;
                            log(
                                "‚ö†Ô∏è Session attempt taking longer than expected (>3s)",
                                "warning"
                            );
                            log(
                                "üîç This likely means AdvantageAdSlotResponder is not receiving messages",
                                "warning"
                            );
                        }
                    }, 3000);

                    const session = await sessionPromise;

                    if (session) {
                        sessionActive = true;
                        updateStatus(
                            "communication-status",
                            "‚úÖ [IFRAME] Session established with parent!",
                            "success"
                        );
                        log("‚úÖ Session established successfully", "success");
                        log(
                            "üéØ Pre-wrapping + iframe messaging architecture working!",
                            "success"
                        );
                        log(
                            "üöÄ Creative can now communicate with AdvantageWrapper in parent window",
                            "success"
                        );

                        // Show the creative
                        document.body.style.opacity = "1";
                    } else {
                        updateStatus(
                            "communication-status",
                            "‚ùå [IFRAME] Session failed - no AdvantageWrapper",
                            "error"
                        );
                        log(
                            "‚ùå Session failed - no AdvantageWrapper found in parent",
                            "error"
                        );
                        log(
                            "‚ö†Ô∏è This could mean pre-wrapping failed or messaging is blocked",
                            "warning"
                        );

                        // Still show the creative for debugging
                        document.body.style.opacity = "1";
                    }
                } catch (error) {
                    updateStatus(
                        "communication-status",
                        "‚ùå [IFRAME] Communication error",
                        "error"
                    );
                    log(`‚ùå Error: ${error.message}`, "error");
                    console.error("Full error:", error);

                    // Still show the creative for debugging
                    document.body.style.opacity = "1";
                } finally {
                    initializationInProgress = false;
                }
            }

            window.requestFormat = async function () {
                if (!sessionActive || !messenger) {
                    updateStatus(
                        "format-status",
                        "‚ùå No active session",
                        "error"
                    );
                    log(
                        "‚ùå Cannot request format - no active session",
                        "error"
                    );
                    return;
                }

                try {
                    log("üì® Requesting TopScroll format...");
                    updateStatus(
                        "format-status",
                        "üì® [IFRAME] Requesting TopScroll format...",
                        "default"
                    );

                    const response = await messenger.sendMessage({
                        action: AdvantageMessageAction.REQUEST_FORMAT,
                        format: AdvantageFormatName.TopScroll
                    });

                    if (
                        response?.action ===
                        AdvantageMessageAction.FORMAT_CONFIRMED
                    ) {
                        updateStatus(
                            "format-status",
                            "üéâ [IFRAME] TopScroll format confirmed!",
                            "success"
                        );
                        log(
                            "üéâ TopScroll format confirmed by website",
                            "success"
                        );
                        log("‚ú® Creative is now running in TopScroll mode");
                    } else if (
                        response?.action ===
                        AdvantageMessageAction.FORMAT_REJECTED
                    ) {
                        updateStatus(
                            "format-status",
                            "‚ùå [IFRAME] TopScroll format rejected",
                            "error"
                        );
                        log("‚ùå TopScroll format rejected by website", "error");
                    } else {
                        updateStatus(
                            "format-status",
                            "‚ùì [IFRAME] Unexpected response",
                            "error"
                        );
                        log(
                            `‚ùì Unexpected response: ${JSON.stringify(
                                response
                            )}`,
                            "warning"
                        );
                    }
                } catch (error) {
                    updateStatus(
                        "format-status",
                        "‚ùå [IFRAME] Format request failed",
                        "error"
                    );
                    log(`‚ùå Format request error: ${error.message}`, "error");
                }
            };

            // Start communication with longer delays to ensure everything is ready
            document.addEventListener("DOMContentLoaded", () => {
                setTimeout(initializeCommunication, 1500); // Increased delay
            });

            // Also try after a longer delay if DOMContentLoaded already fired
            setTimeout(initializeCommunication, 2000); // Increased fallback delay
        </script>
    </body>
</html>
